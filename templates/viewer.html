{% extends "base.html" %}

{% block title %}{{ novel.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/viewer.css') }}">

{% endblock %}

{% block content %}
<div class="novel-viewer">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–µ–ª–ª—ã -->
    <div class="novel-header">
        <h1 class="novel-title">{{ novel.title }}</h1>
        <div class="author-info">
            <div class="author-avatar">
                {{ novel.author.nickname[:1].upper() if novel.author.nickname else 'A' }}
            </div>
            <div>
                <div class="novel-author">–ê–≤—Ç–æ—Ä: {{ novel.author.nickname }}</div>
                <div class="novel-date">{{ novel.created_at.strftime('%d.%m.%Y') }}</div>
            </div>
        </div>
        
        {% if novel.description %}
            <div class="novel-description">
                {{ novel.description }}
            </div>
        {% endif %}
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ -->
    <div class="scene-info">
        <span>–°—Ü–µ–Ω–∞ <span id="current-scene">1</span> –∏–∑ <span id="total-scenes">{{ scenes|length }}</span></span>
        <span id="progress-percent">0%</span>
    </div>
    
    <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ü–µ–Ω—ã -->
    <div class="scene-container">
        <div id="scene-display" class="scene-content">
            <!-- –°—Ü–µ–Ω–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ -->
        <div id="choices-display" class="choices-container">
            <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å -->
        </div>
    </div>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="navigation">
        <button onclick="prevScene()" id="prev-btn" class="nav-btn nav-btn-prev">
            ‚Üê –ù–∞–∑–∞–¥
        </button>
        <button onclick="nextScene()" id="next-btn" class="nav-btn nav-btn-next">
            –î–∞–ª–µ–µ ‚Üí
        </button>
    </div>
</div>

<!-- –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–ª–ª—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ -->
<script type="application/json" id="novel-data">
{
    "id": {{ novel.id }},
    "title": {{ novel.title|tojson }},
    "scenes": [
        {% for scene in scenes %}
        {
            "id": {{ scene.id }},
            "text": {{ scene.text|tojson }},
            "background": {% if scene.background %}{{ scene.background|tojson }}{% else %}null{% endif %},
            "choices": [
                {% if scene.choices %}
                    {% for choice in scene.choices %}
                    {
                        "text": {{ choice.text|tojson }},
                        "nextScene": {{ choice.nextScene if choice.nextScene is defined else choice.next_scene if choice.next_scene is defined else 0 }}
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                {% endif %}
            ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
}
</script>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentSceneIndex = 0;
let scenesData = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON
function loadNovelData() {
    try {
        const dataElement = document.getElementById('novel-data');
        if (!dataElement) {
            console.error('Element with novel data not found');
            return { scenes: [] };
        }
        
        const jsonText = dataElement.textContent.trim();
        if (!jsonText) {
            console.error('No JSON data found');
            return { scenes: [] };
        }
        
        return JSON.parse(jsonText);
    } catch (error) {
        console.error('Error parsing novel data:', error);
        return { scenes: [] };
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    const novelData = loadNovelData();
    scenesData = novelData.scenes || [];
    
    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã —Å—Ü–µ–Ω—ã:', scenesData.length);
    
    if (scenesData.length > 0) {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ü–µ–Ω—É
        displayScene(0);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ü–µ–Ω
        document.getElementById('total-scenes').textContent = scenesData.length;
    } else {
        // –ù–µ—Ç —Å—Ü–µ–Ω
        showNoScenesMessage();
    }
});

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã
function displayScene(index) {
    if (index < 0 || index >= scenesData.length) {
        showEndMessage();
        return;
    }
    
    currentSceneIndex = index;
    const scene = scenesData[index];
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    document.getElementById('current-scene').textContent = index + 1;
    
    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å—Ü–µ–Ω—ã
    let sceneHTML = '';
    
    // –§–æ–Ω —Å—Ü–µ–Ω—ã
    if (scene.background) {
        sceneHTML += `
            <div class="scene-background">
                <img src="${escapeHtml(scene.background)}" alt="–§–æ–Ω —Å—Ü–µ–Ω—ã" 
                     onerror="this.style.display='none'">
            </div>
        `;
    }
    
    // –¢–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã
    const sceneText = scene.text ? scene.text.replace(/\n/g, '<br>') : '...';
    sceneHTML += `
        <div class="scene-text">
            ${sceneText}
        </div>
    `;
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å—Ü–µ–Ω—É
    document.getElementById('scene-display').innerHTML = sceneHTML;
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞
    displayChoices(scene.choices);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    updateProgress(index);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    updateNavigation(index, scene.choices);
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–∞–≤–µ—Ä—Ö
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞
function displayChoices(choices) {
    const choicesContainer = document.getElementById('choices-display');
    
    if (!choices || choices.length === 0) {
        // –ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞
        choicesContainer.innerHTML = '';
        return;
    }
    
    let choicesHTML = '<h3>–í–∞—à –≤—ã–±–æ—Ä:</h3>';
    
    choices.forEach((choice, index) => {
        const choiceText = choice.text || `–í–∞—Ä–∏–∞–Ω—Ç ${index + 1}`;
        const nextScene = choice.nextScene || 0;
        
        if (nextScene === 0) {
            // –ö–æ–Ω–µ—Ü –∏—Å—Ç–æ—Ä–∏–∏
            choicesHTML += `
                <button class="choice-btn choice-end" onclick="showEndMessage('üéâ ${escapeHtml(choiceText)}')">
                    ${escapeHtml(choiceText)}
                </button>
            `;
        } else if (nextScene > 0 && nextScene <= scenesData.length) {
            // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –¥—Ä—É–≥–æ–π —Å—Ü–µ–Ω–µ
            choicesHTML += `
                <button class="choice-btn" onclick="goToScene(${nextScene - 1})">
                    ${escapeHtml(choiceText)}
                </button>
            `;
        } else {
            // –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ü–µ–Ω—ã
            choicesHTML += `
                <button class="choice-btn" onclick="nextScene()">
                    ${escapeHtml(choiceText)}
                </button>
            `;
        }
    });
    
    choicesContainer.innerHTML = choicesHTML;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgress(index) {
    const progress = ((index + 1) / scenesData.length) * 100;
    document.getElementById('progress-bar').style.width = `${progress}%`;
    document.getElementById('progress-percent').textContent = `${Math.round(progress)}%`;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
function updateNavigation(index, choices) {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
    prevBtn.style.display = index > 0 ? 'block' : 'none';
    
    // –ö–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ" –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞
    const hasChoices = choices && choices.length > 0;
    const hasNextScene = index < scenesData.length - 1;
    
    nextBtn.style.display = (!hasChoices && hasNextScene) ? 'block' : 'none';
}

// –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ü–µ–Ω–µ
function goToScene(index) {
    if (index >= 0 && index < scenesData.length) {
        displayScene(index);
    } else {
        showEndMessage();
    }
}

// –°–ª–µ–¥—É—é—â–∞—è —Å—Ü–µ–Ω–∞
function nextScene() {
    if (currentSceneIndex < scenesData.length - 1) {
        displayScene(currentSceneIndex + 1);
    } else {
        showEndMessage();
    }
}

// –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ü–µ–Ω–∞
function prevScene() {
    if (currentSceneIndex > 0) {
        displayScene(currentSceneIndex - 1);
    }
}

// –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∫–æ–Ω—Ü–µ –∏—Å—Ç–æ—Ä–∏–∏
function showEndMessage(customMessage = null) {
    const message = customMessage || 'üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—á–∏—Ç–∞–ª–∏ –Ω–æ–≤–µ–ª–ª—É –¥–æ –∫–æ–Ω—Ü–∞.';
    
    document.getElementById('scene-display').innerHTML = `
        <div class="end-message">
            <h3>–ö–æ–Ω–µ—Ü –∏—Å—Ç–æ—Ä–∏–∏</h3>
            <p>${message}</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="displayScene(0)" class="btn btn-primary">
                    üìñ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                </button>
                <button onclick="window.location.href='/'" class="btn btn-secondary">
                    üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                </button>
                {% if current_user.is_authenticated %}
                <button onclick="window.location.href='/builder'" class="btn btn-success">
                    ‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é
                </button>
                {% endif %}
            </div>
        </div>
    `;
    
    document.getElementById('choices-display').innerHTML = '';
    document.getElementById('prev-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('progress-bar').style.width = '100%';
    document.getElementById('progress-percent').textContent = '100%';
}

// –°–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç —Å—Ü–µ–Ω"
function showNoScenesMessage() {
    document.getElementById('scene-display').innerHTML = `
        <div class="error-message">
            <h3>–í —ç—Ç–æ–π –Ω–æ–≤–µ–ª–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç —Å—Ü–µ–Ω</h3>
            <p>–ê–≤—Ç–æ—Ä –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–∏–ª —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ.</p>
            <button onclick="window.location.href='/'" class="btn btn-primary">
                ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            </button>
        </div>
    `;
    
    document.getElementById('choices-display').innerHTML = '';
    document.getElementById('prev-btn').style.display = 'none';
    document.getElementById('next-btn').style.display = 'none';
}

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
function escapeHtml(text) {
    if (typeof text !== 'string') return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏—à–∞–º–∏
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowRight' || e.key === ' ') {
        e.preventDefault();
        nextScene();
    }
    if (e.key === 'ArrowLeft') {
        e.preventDefault();
        prevScene();
    }
});

// –ö–Ω–æ–ø–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
});

function handleSwipe() {
    const swipeThreshold = 50;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
            // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - –≤–ø–µ—Ä–µ–¥
            nextScene();
        } else {
            // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - –Ω–∞–∑–∞–¥
            prevScene();
        }
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
console.log('–î–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–ª–ª—ã:', loadNovelData());
</script>
{% endblock %}