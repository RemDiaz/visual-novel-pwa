{% extends "base.html" %}

{% block title %}{% if novel %}–†–µ–¥–∞–∫—Ç–æ—Ä: {{ novel.title }}{% else %}–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –Ω–æ–≤–µ–ª–ª{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/builder.css') }}">
{% endblock %}

{% block content %}
<div id="builder-app">
    {% if not novel %}
        <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–µ–ª–ª—ã -->
        <div class="create-novel-form">
            <h2 class="form-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –Ω–æ–≤–µ–ª–ª—É</h2>
            <form action="/create_novel" method="POST">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–µ–ª–ª—ã:</label>
                    <input type="text" name="title" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                    <textarea name="description" class="form-control" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—é–∂–µ—Ç–∞"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üéÆ –°–æ–∑–¥–∞—Ç—å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä—É
                </button>
            </form>
        </div>
    {% else %}
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä -->
        <div class="builder-container">
            <!-- –®–∞–ø–∫–∞ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ -->
            <div class="builder-header">
                <h2 id="novel-title-display">{{ novel.title }}</h2>
                <div class="builder-controls">
                    <button onclick="saveNovel()" class="btn btn-primary" id="save-btn">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button onclick="previewNovel()" class="btn btn-secondary">
                        üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                    </button>
                    <button onclick="addNewScene()" class="btn btn-success">
                        ‚ûï –ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞
                    </button>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
            <div class="builder-main">
                <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å–æ —Å—Ü–µ–Ω–∞–º–∏ -->
                <div class="scenes-sidebar">
                    <h3>–°—Ü–µ–Ω—ã</h3>
                    <div class="scene-list" id="scene-list">
                        <!-- –°—Ü–µ–Ω—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
                    </div>
                    <button onclick="addNewScene()" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω—É
                    </button>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
                <div class="editor-main">
                    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ü–µ–Ω—ã -->
                    <div class="scene-editor">
                        <h3>–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ü–µ–Ω—ã <span id="current-scene-number"></span></h3>
                        
                        <div class="form-group">
                            <label class="form-label">–¢–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã:</label>
                            <textarea id="scene-text" class="form-control" rows="6" 
                                      placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —ç—Ç–æ–π —Å—Ü–µ–Ω–µ..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (URL):</label>
                            <input type="text" id="scene-background" class="form-control" 
                                   placeholder="https://example.com/image.jpg">
                            <small class="text-muted">–ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º</small>
                        </div>
                        
                        <button onclick="saveCurrentScene()" class="btn btn-primary">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ü–µ–Ω—É
                        </button>
                    </div>

                    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –≤—ã–±–æ—Ä–æ–≤ -->
                    <div class="choices-editor">
                        <h3>–í–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞</h3>
                        <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–≤–∏–¥–∏—Ç —á–∏—Ç–∞—Ç–µ–ª—å –≤ –∫–æ–Ω—Ü–µ —ç—Ç–æ–π —Å—Ü–µ–Ω—ã</p>
                        
                        <div id="choices-list">
                            <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                        </div>
                        
                        <button onclick="addNewChoice()" class="btn btn-success" style="margin-top: 15px;">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–æ—Ä–∞
                        </button>
                    </div>

                    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ü–µ–Ω—ã -->
                    <div class="scene-preview-box">
                        <h4>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ü–µ–Ω—ã:</h4>
                        <div id="scene-preview-content">
                            <em>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω—É –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</em>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–æ–≤–µ–ª–ª—ã -->
            <div class="novel-settings">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–æ–≤–µ–ª–ª—ã</h3>
                
                <div class="settings-grid">
                    <div class="form-group">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–µ–ª–ª—ã:</label>
                        <input type="text" id="novel-title" class="form-control" value="{{ novel.title }}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="novel-description" class="form-control" rows="3">{{ novel.description }}</textarea>
                    </div>
                </div>

                <!-- –ü—É–±–ª–∏–∫–∞—Ü–∏—è -->
                <div class="publish-section">
                    <div class="publish-status">
                        <strong>–°—Ç–∞—Ç—É—Å:</strong>
                        <span id="publish-status-badge" class="status-badge {% if novel.is_published %}status-published{% else %}status-draft{% endif %}">
                            {% if novel.is_published %}–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ{% else %}–ß–µ—Ä–Ω–æ–≤–∏–∫{% endif %}
                        </span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="novel-published" {% if novel.is_published %}checked{% endif %}>
                            –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–µ–ª–ª—É (—Å–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª—è –≤—Å–µ—Ö)
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <button onclick="publishNovel()" class="btn btn-success" id="publish-btn">
                            {% if novel.is_published %}‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ{% else %}üì¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å{% endif %}
                        </button>
                        <small class="text-muted" style="display: block; margin-top: 5px;">
                            –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–ª–ª—ã –≤–∏–¥–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        </small>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
<div id="notification-area"></div>

<!-- –ü–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ ID –Ω–æ–≤–µ–ª–ª—ã, –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∑–∞–≥—Ä—É–∑–∏–º —á–µ—Ä–µ–∑ API -->
<div id="novel-data" data-novel-id="{{ novel.id if novel else 0 }}" style="display: none;"></div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentNovelId = document.getElementById('novel-data') ? 
    parseInt(document.getElementById('novel-data').getAttribute('data-novel-id')) : 0;
let scenes = [];
let currentSceneIndex = -1;
let choices = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    if (currentNovelId && currentNovelId > 0) {
        loadNovelData();
    } else if (currentNovelId === 0 && window.location.pathname.includes('/builder/')) {
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä –±–µ–∑ ID, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º
        window.location.href = '/builder';
    }
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–æ–≤–µ–ª–ª—ã —á–µ—Ä–µ–∑ AJAX
async function loadNovelData() {
    try {
        showLoading();
        
        const response = await fetch(`/api/novel/${currentNovelId}`);
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
        
        const data = await response.json();
        
        if (data.error) {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.error, 'error');
            return;
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ü–µ–Ω—ã
        scenes = data.scenes || [];
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateNovelTitle(data.title);
        document.getElementById('novel-title').value = data.title || '';
        document.getElementById('novel-description').value = data.description || '';
        document.getElementById('novel-published').checked = data.is_published || false;
        updatePublishStatus(data.is_published);
        
        // –†–µ–Ω–¥–µ—Ä–∏–º —Å—Ü–µ–Ω—ã
        renderSceneList();
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ü–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é
        if (scenes.length > 0) {
            selectScene(0);
        } else {
            // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ü–µ–Ω—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            addNewScene();
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
        showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–µ–ª–ª—ã', 'error');
    } finally {
        hideLoading();
    }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ü–µ–Ω—ã
function addNewScene() {
    const newScene = {
        id: 'scene_' + Date.now(), // –í—Ä–µ–º–µ–Ω–Ω—ã–π ID
        text: '',
        background: '',
        order: scenes.length,
        choices: []
    };
    
    scenes.push(newScene);
    renderSceneList();
    selectScene(scenes.length - 1);
    
    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ —Ç–µ–∫—Å—Ç–∞
    setTimeout(() => {
        document.getElementById('scene-text').focus();
    }, 100);
}

// –í—ã–±–æ—Ä —Å—Ü–µ–Ω—ã
function selectScene(index) {
    if (index < 0 || index >= scenes.length) return;
    
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω
    document.querySelectorAll('.scene-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ü–µ–Ω—É
    const sceneItems = document.querySelectorAll('.scene-item');
    if (sceneItems[index]) {
        sceneItems[index].classList.add('active');
    }
    
    currentSceneIndex = index;
    const scene = scenes[index];
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    document.getElementById('current-scene-number').textContent = `(–°—Ü–µ–Ω–∞ ${index + 1})`;
    document.getElementById('scene-text').value = scene.text || '';
    document.getElementById('scene-background').value = scene.background || '';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞
    choices = Array.isArray(scene.choices) ? scene.choices : [];
    renderChoicesList();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    updateScenePreview();
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å—Ü–µ–Ω—ã
function saveCurrentScene() {
    if (currentSceneIndex === -1) {
        showNotification('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ü–µ–Ω—É', 'info');
        return;
    }
    
    const scene = scenes[currentSceneIndex];
    scene.text = document.getElementById('scene-text').value;
    scene.background = document.getElementById('scene-background').value;
    scene.choices = [...choices]; // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–∫–µ
    renderSceneList();
    updateScenePreview();
    
    showNotification('‚úÖ –°—Ü–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤—ã–±–æ—Ä–∞
function addNewChoice() {
    if (currentSceneIndex === -1) {
        showNotification('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ü–µ–Ω—É', 'info');
        return;
    }
    
    const newChoice = {
        id: 'choice_' + Date.now(),
        text: '',
        nextScene: scenes.length > 1 ? 2 : 1 // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–µ–¥–µ—Ç –Ω–∞ –≤—Ç–æ—Ä—É—é —Å—Ü–µ–Ω—É –∏–ª–∏ –ø–µ—Ä–≤—É—é
    };
    
    choices.push(newChoice);
    renderChoicesList();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤—ã–±–æ—Ä–∞
function deleteChoice(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–æ—Ä–∞?')) {
        choices.splice(index, 1);
        renderChoicesList();
    }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Å—Ü–µ–Ω
function renderSceneList() {
    const sceneList = document.getElementById('scene-list');
    if (!sceneList) return;
    
    sceneList.innerHTML = '';
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ü–µ–Ω—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
    scenes.sort((a, b) => (a.order || 0) - (b.order || 0));
    
    scenes.forEach((scene, index) => {
        const sceneElement = document.createElement('div');
        sceneElement.className = `scene-item ${index === currentSceneIndex ? 'active' : ''}`;
        sceneElement.onclick = () => selectScene(index);
        
        const previewText = scene.text ? 
            (scene.text.length > 50 ? scene.text.substring(0, 50) + '...' : scene.text) :
            '<em>–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞</em>';
        
        const choiceCount = Array.isArray(scene.choices) ? scene.choices.length : 0;
        
        sceneElement.innerHTML = `
            <div class="scene-item-header">
                <span class="scene-number">–°—Ü–µ–Ω–∞ ${index + 1}</span>
                <button onclick="event.stopPropagation(); deleteScene(${index})" class="btn btn-sm btn-danger">
                    ‚úï
                </button>
            </div>
            <div class="scene-preview-text">
                ${escapeHtml(previewText)}
            </div>
            ${choiceCount > 0 ? `<small>–í–∞—Ä–∏–∞–Ω—Ç–æ–≤: ${choiceCount}</small>` : ''}
        `;
        
        sceneList.appendChild(sceneElement);
    });
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ –≤—ã–±–æ—Ä–æ–≤
function renderChoicesList() {
    const choicesList = document.getElementById('choices-list');
    if (!choicesList) return;
    
    choicesList.innerHTML = '';
    
    if (choices.length === 0) {
        choicesList.innerHTML = `
            <div class="empty-choices">
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞.</p>
                <p>–ß–∏—Ç–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ".</p>
            </div>
        `;
        return;
    }
    
    choices.forEach((choice, index) => {
        const choiceElement = document.createElement('div');
        choiceElement.className = 'choice-item';
        
        // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω –¥–ª—è –≤—ã–±–æ—Ä–∞
        let sceneOptions = '';
        scenes.forEach((scene, sceneIndex) => {
            const sceneNum = sceneIndex + 1;
            sceneOptions += `<option value="${sceneNum}" ${choice.nextScene === sceneNum ? 'selected' : ''}>
                –°—Ü–µ–Ω–∞ ${sceneNum}
            </option>`;
        });
        
        choiceElement.innerHTML = `
            <div class="choice-header">
                <strong>–í–∞—Ä–∏–∞–Ω—Ç ${index + 1}</strong>
                <div class="choice-actions">
                    <button onclick="moveChoiceUp(${index})" class="btn btn-sm btn-secondary" ${index === 0 ? 'disabled' : ''}>
                        ‚Üë
                    </button>
                    <button onclick="moveChoiceDown(${index})" class="btn btn-sm btn-secondary" ${index === choices.length - 1 ? 'disabled' : ''}>
                        ‚Üì
                    </button>
                    <button onclick="deleteChoice(${index})" class="btn btn-sm btn-danger">
                        ‚úï
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞:</label>
                <input type="text" class="form-control choice-text" 
                       value="${escapeHtml(choice.text || '')}" 
                       placeholder="–ß—Ç–æ –≤—ã–±–µ—Ä–µ—Ç —á–∏—Ç–∞—Ç–µ–ª—å?"
                       oninput="updateChoiceText(${index}, this.value)">
            </div>
            <div class="form-group">
                <label class="form-label">–í–µ–¥–µ—Ç –Ω–∞ —Å—Ü–µ–Ω—É:</label>
                <select class="form-control choice-next-scene" 
                        onchange="updateChoiceNextScene(${index}, this.value)">
                    ${sceneOptions}
                    <option value="0" ${choice.nextScene === 0 ? 'selected' : ''}>–ö–æ–Ω–µ—Ü –∏—Å—Ç–æ—Ä–∏–∏</option>
                </select>
            </div>
        `;
        
        choicesList.appendChild(choiceElement);
    });
}

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
function escapeHtml(text) {
    if (typeof text !== 'string') return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞
function updateChoiceText(index, text) {
    if (choices[index]) {
        choices[index].text = text;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ü–µ–Ω—ã –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–∞
function updateChoiceNextScene(index, nextScene) {
    if (choices[index]) {
        choices[index].nextScene = parseInt(nextScene);
    }
}

// –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤–≤–µ—Ä—Ö
function moveChoiceUp(index) {
    if (index > 0) {
        [choices[index], choices[index - 1]] = [choices[index - 1], choices[index]];
        renderChoicesList();
    }
}

// –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤–Ω–∏–∑
function moveChoiceDown(index) {
    if (index < choices.length - 1) {
        [choices[index], choices[index + 1]] = [choices[index + 1], choices[index]];
        renderChoicesList();
    }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ü–µ–Ω—ã
function deleteScene(index) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ü–µ–Ω—É ${index + 1}? –í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞ –≤ —ç—Ç–æ–π —Å—Ü–µ–Ω–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.`)) {
        return;
    }
    
    scenes.splice(index, 1);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å—Ü–µ–Ω
    scenes.forEach((scene, i) => {
        scene.order = i;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫–∏ –≤ –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö –≤—ã–±–æ—Ä–∞
    scenes.forEach(scene => {
        if (scene.choices) {
            scene.choices.forEach(choice => {
                if (choice.nextScene > index + 1) {
                    choice.nextScene--;
                } else if (choice.nextScene === index + 1) {
                    choice.nextScene = 0; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∫–æ–Ω–µ—Ü
                }
            });
        }
    });
    
    // –í—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥—É—é —Å—Ü–µ–Ω—É
    if (scenes.length > 0) {
        selectScene(Math.max(0, index - 1));
    } else {
        addNewScene();
    }
    
    renderSceneList();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
function updateScenePreview() {
    const preview = document.getElementById('scene-preview-content');
    const scene = scenes[currentSceneIndex];
    
    if (!scene) {
        preview.innerHTML = '<em>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω—É –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</em>';
        return;
    }
    
    let previewHTML = '';
    
    if (scene.background) {
        previewHTML += `
            <div style="margin-bottom: 15px;">
                <img src="${escapeHtml(scene.background)}" alt="–§–æ–Ω" style="max-width: 100%; border-radius: 5px;" 
                     onerror="this.style.display='none'">
            </div>
        `;
    }
    
    previewHTML += `
        <p style="font-size: 16px; line-height: 1.6;">${scene.text ? escapeHtml(scene.text) : '<em>–¢–µ–∫—Å—Ç —Å—Ü–µ–Ω—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω</em>'}</p>
    `;
    
    const currentChoices = Array.isArray(scene.choices) ? scene.choices : [];
    
    if (currentChoices.length > 0) {
        previewHTML += '<div style="margin-top: 20px;"><strong>–í–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞:</strong></div>';
        currentChoices.forEach((choice, index) => {
            const targetText = choice.nextScene === 0 ? '–ö–æ–Ω–µ—Ü –∏—Å—Ç–æ—Ä–∏–∏' : `–°—Ü–µ–Ω–∞ ${choice.nextScene}`;
            previewHTML += `
                <div style="background: #e9ecef; padding: 10px; margin: 5px 0; border-radius: 5px;">
                    "${choice.text || '–ù–µ —É–∫–∞–∑–∞–Ω —Ç–µ–∫—Å—Ç'}" ‚Üí ${targetText}
                </div>
            `;
        });
    } else {
        previewHTML += '<div style="margin-top: 20px; color: #666;"><em>–í–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ –Ω–µ—Ç. –ë—É–¥–µ—Ç –∫–Ω–æ–ø–∫–∞ "–î–∞–ª–µ–µ"</em></div>';
    }
    
    preview.innerHTML = previewHTML;
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ–π –Ω–æ–≤–µ–ª–ª—ã
async function saveNovel() {
    try {
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ü–µ–Ω—É
        if (currentSceneIndex !== -1) {
            saveCurrentScene();
        }
        
        const saveBtn = document.getElementById('save-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        const novelData = {
            title: document.getElementById('novel-title').value,
            description: document.getElementById('novel-description').value,
            is_published: document.getElementById('novel-published').checked,
            scenes: scenes.map(scene => ({
                ...scene,
                choices: Array.isArray(scene.choices) ? scene.choices : []
            }))
        };
        
        const response = await fetch(`/api/save_novel/${currentNovelId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(novelData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('‚úÖ –ù–æ–≤–µ–ª–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
            updateNovelTitle(novelData.title);
            updatePublishStatus(novelData.is_published);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            const publishBtn = document.getElementById('publish-btn');
            publishBtn.innerHTML = novelData.is_published ? '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : 'üì¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
            publishBtn.disabled = novelData.is_published;
            
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + data.error, 'error');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'error');
    } finally {
        const saveBtn = document.getElementById('save-btn');
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    }
}

// –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–æ–≤–µ–ª–ª—ã
async function publishNovel() {
    try {
        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
        await saveNovel();
        
        const response = await fetch(`/api/publish_novel/${currentNovelId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('üéâ –ù–æ–≤–µ–ª–ª–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!', 'success');
            updatePublishStatus(true);
            document.getElementById('novel-published').checked = true;
            
            const publishBtn = document.getElementById('publish-btn');
            publishBtn.innerHTML = '‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ';
            publishBtn.disabled = true;
            
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + data.error, 'error');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏', 'error');
    }
}

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–æ–≤–µ–ª–ª—ã
function previewNovel() {
    if (currentNovelId) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–¥ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º
        saveNovel().then(() => {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            window.open(`/view/${currentNovelId}`, '_blank');
        }).catch(error => {
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–µ—Ä–µ–¥ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º', 'error');
        });
    } else {
        showNotification('‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –Ω–æ–≤–µ–ª–ª—É', 'error');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function updateNovelTitle(title) {
    const titleElement = document.getElementById('novel-title-display');
    if (titleElement) {
        titleElement.textContent = title;
    }
}

function updatePublishStatus(isPublished) {
    const badge = document.getElementById('publish-status-badge');
    if (badge) {
        badge.textContent = isPublished ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫';
        badge.className = `status-badge ${isPublished ? 'status-published' : 'status-draft'}`;
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
    const notificationArea = document.getElementById('notification-area');
    if (!notificationArea) return;
    
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-width: 400px;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}
            <span>${message}</span>
        </div>
    `;
    
    notificationArea.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
function showLoading() {
    let loading = document.getElementById('loading-overlay');
    if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loading-overlay';
        loading.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        `;
        loading.innerHTML = `
            <div class="loading-spinner"></div>
        `;
        document.body.appendChild(loading);
    }
}

// –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
function hideLoading() {
    const loading = document.getElementById('loading-overlay');
    if (loading && loading.parentNode) {
        loading.parentNode.removeChild(loading);
    }
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
document.addEventListener('DOMContentLoaded', function() {
    const autoSaveFields = [
        document.getElementById('scene-text'),
        document.getElementById('scene-background'),
        document.getElementById('novel-title'),
        document.getElementById('novel-description')
    ];
    
    autoSaveFields.forEach(field => {
        if (field) {
            field.addEventListener('blur', () => {
                if (currentSceneIndex !== -1) {
                    setTimeout(saveCurrentScene, 100);
                }
            });
        }
    });
});

// –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
if (!document.getElementById('notification-styles')) {
    const style = document.createElement('style');
    style.id = 'notification-styles';
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
}
</script>
{% endblock %}